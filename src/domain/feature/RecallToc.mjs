// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Tilia from "tilia/src/Tilia.mjs";
import * as Core__Option from "@rescript/core/src/Core__Option.mjs";

async function loadProgress(prog, set, info) {
  var p = await prog.get(info.id);
  if (p !== undefined) {
    return set({
                info: info,
                prog: {
                  TAG: "Started",
                  _0: p
                }
              });
  } else {
    return set({
                info: info,
                prog: "NotStarted"
              });
  }
}

function stacks(repo, path) {
  return async function (setList) {
    console.log("LOADING STACKS");
    var list = (await repo.stack.toc(path)).map(function (info) {
          return {
                  info: info,
                  prog: "Loading"
                };
        });
    console.log("STACKS: " + Core__Option.getExn(JSON.stringify(list, undefined, 2), undefined));
    setList(list);
    list.forEach(function (param, i) {
          loadProgress(repo.progress, (function (extra) {
                  list[i] = extra;
                }), param.info);
        });
  };
}

function setActive(param) {
  var save = param.save;
  return function (param) {
    var stacks = param.stacks;
    return function (id, active) {
      var i = stacks.findIndex(function (v) {
            return v.info.id === id;
          });
      if (i === -1) {
        return ;
      }
      var match = stacks[i];
      if (match === undefined) {
        return ;
      }
      var p = match.prog;
      var info = match.info;
      if (typeof p !== "object") {
        if (p === "Loading") {
          return ;
        }
        var p$1 = {
          id: info.id,
          active: active,
          cards: {}
        };
        stacks[i] = {
          info: info,
          prog: {
            TAG: "Started",
            _0: p$1
          }
        };
        save(p$1);
        return ;
      } else {
        var p$2 = p._0;
        p$2.active = active;
        save(p$2);
        return ;
      }
    };
  };
}

function make(repo, path) {
  return Tilia.carve(function (param) {
              return {
                      stacks: Tilia.source(stacks(repo, path), []),
                      setActive: param.derived(setActive(repo.progress))
                    };
            });
}

export {
  loadProgress ,
  stacks ,
  setActive ,
  make ,
}
/* Tilia Not a pure module */
